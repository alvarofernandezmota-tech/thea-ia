# =======================================================
# THEA IA v0.15.0 — ENVIRONMENT CONFIGURATION, ENTERPRISE
# =======================================================
# Última actualización: 2025-11-14
# Responsable: Álvaro Fernández Mota (CEO THEA IA)
# Notas: H02 completado - Database Layer + Telegram funcional

# ---- GENERAL APP/ENVIRONMENT ----
APP_NAME=Thea IA
APP_VERSION=0.15.0
ENVIRONMENT=production  # development, staging, production
DEBUG=false
LOG_LEVEL=INFO
LOG_FORMAT=json

# ---- API & WEB SERVER ----
API_HOST=0.0.0.0
API_PORT=8000
API_PREFIX=/api/v1
API_TIMEOUT_SECONDS=30
SECRET_KEY=change_this_in_production_please_32chars_min
JWT_ALGORITHM=HS256
JWT_EXPIRE_HOURS=24
JWT_REFRESH_EXPIRE_DAYS=7

# ---- DATABASE CONFIGURATION (H02 - COMPLETADO 12 Nov 2025) ----
# PostgreSQL obligatorio desde H02 (multi-tenant architecture)
DATABASE_TYPE=postgresql
DATABASE_URL=postgresql+asyncpg://thea_user:thea_password@localhost:5432/theaia_db
# Desarrollo local: postgresql+asyncpg://postgres@127.0.0.1:5432/theaia_dev
# Producción: usar pg_hba.conf con md5/scram-sha-256, NO trust mode
DATABASE_POOL_SIZE=10
DATABASE_POOL_OVERFLOW=20
DATABASE_TIMEOUT=30
DATABASE_ECHO=false  # true para debug SQL queries

# Multi-tenant (OBLIGATORIO desde H02)
DEFAULT_TENANT_ID=default_tenant
TENANT_ID_REQUIRED=true

# Alembic Migrations (H02)
ALEMBIC_CONFIG=alembic.ini
ALEMBIC_SCRIPT_LOCATION=migrations
ALEMBIC_VERSION_TABLE=alembic_version

# SQLite fallback (NO recomendado para producción)
SQLITE_URL=sqlite+aiosqlite:///./data/theaia.db
SQLITE_CHECK_SAME_THREAD=false

# ---- CACHE & MESSAGE QUEUES ----
CACHE_ENABLED=true
CACHE_BACKEND=redis
CACHE_TTL_SECONDS=3600
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0
REDIS_URI=redis://localhost:6379/0
REDIS_POOL_SIZE=10

CELERY_ENABLED=false
CELERY_BROKER_URL=redis://localhost:6379/1
CELERY_RESULT_BACKEND=redis://localhost:6379/2

# ---- FSM & SESSION MANAGER (H01-H03) ----
THEA_CORE_ENABLED=true
THEA_ROUTER_CLASS=TheaRouter
THEA_SESSION_MANAGER_ENABLED=true
FSM_ENABLED=true
FSM_TIMEOUT_SECONDS=300
FSM_LOG_TRANSITIONS=true
CONTEXT_MANAGER_CLASS=SessionManager
CONTEXT_PERSISTENCE_TYPE=database  # database (PostgreSQL) o redis
CONTEXT_TTL_SECONDS=86400

# ---- AGENTS & ADAPTERS ----
AGENTS_ENABLED=true
ENABLED_ADAPTERS=telegram  # telegram funcional (H02), rest pendiente (H10)

# Agentes disponibles (base H01, inteligencia H05-H06)
AGENT_AGENDA_ENABLED=true
AGENT_NOTE_ENABLED=true
AGENT_EVENT_ENABLED=true
AGENT_QUERY_ENABLED=true
AGENT_REMINDER_ENABLED=true
AGENT_SCHEDULER_ENABLED=true
AGENT_HELP_ENABLED=true
AGENT_FALLBACK_ENABLED=true
AGENT_TIMEOUT_SECONDS=60

# ---- TELEGRAM ADAPTER (H02 - COMPLETADO 12 Nov 2025) ----
# Bot funcional con persistencia PostgreSQL
TELEGRAM_BOT_TOKEN=your_bot_token_here_from_botfather
TELEGRAM_WEBHOOK_URL=https://api.theaia.com/webhook/telegram
TELEGRAM_WEBHOOK_SECRET=replace_with_webhook_secret
TELEGRAM_POLLING=true  # true para desarrollo, false para producción con webhooks
TELEGRAM_TIMEOUT_SECONDS=30

# Primera conversación real: Usuario Entu (ID: 6961767622), 12 nov 2025 17:02
# Comandos disponibles: /start, /help, /reset
# Persistencia: usuarios, conversaciones, mensajes automática

# ---- WHATSAPP ADAPTER (H10 - FUTURO) ----
WHATSAPP_ADAPTER_ENABLED=false
WHATSAPP_API_KEY=your_whatsapp_api_key_here
WHATSAPP_PHONE_NUMBER=+1234567890
WHATSAPP_WEBHOOK_URL=https://api.theaia.com/webhook/whatsapp

# ---- REST API (H10 - FUTURO) ----
REST_API_ENABLED=false  # H10
REST_API_VERSION=v1

# ---- WEB CLIENT (H08 - APLAZADO DE H02) ----
# Web Client (React + Vite) y OAuth2/JWT aplazados de H02 a H08
WEB_CLIENT_ENABLED=false  # H08
WEB_CLIENT_URL=https://app.theaia.com
OAUTH2_ENABLED=false  # H08

# ---- MACHINE LEARNING (H06 - FUTURO) ----
# Arquitectura híbrida: Reglas + spaCy + LLM (decisión 14 nov 2025)
ML_ENABLED=false  # H06
INTENT_DETECTOR_CLASS=IntentDetector
INTENT_DETECTOR_MODEL=default
INTENT_CONFIDENCE_THRESHOLD=0.82
INTENT_MODEL_PATH=./models/intent_classifier_v3.pkl

ENTITY_EXTRACTOR_ENABLED=false  # H06
ENTITY_CONFIDENCE_THRESHOLD=0.75
ENTITY_MODEL_PATH=./models/entity_extractor_v3.pkl

SPACY_MODEL=es_core_news_md
ML_BATCH_SIZE=32
ML_CACHE_ENABLED=true

# LLM Integration (H06 - arquitectura híbrida)
LLM_ENABLED=false  # H06
LLM_PROVIDER=openai  # openai, anthropic, local
OPENAI_API_KEY=your_openai_api_key_here
OPENAI_MODEL=gpt-4
OPENAI_TEMPERATURE=0.3
OPENAI_MAX_TOKENS=500

# LangChain (H06)
LANGCHAIN_ENABLED=false
LANGCHAIN_CACHE_ENABLED=true

# RAG (H06)
RAG_ENABLED=false
RAG_VECTOR_DB=chroma
RAG_EMBEDDING_MODEL=openai

# ---- LOGGING, AUDIT & MONITORING ----
LOG_FILE_PATH=./logs/theaia.log
LOG_MAX_SIZE_MB=20
LOG_BACKUP_COUNT=7
LOG_JSON_FORMAT=true

# Auditoría (H02 - message_history table implementada)
AUDIT_ENABLED=true
AUDIT_LOG_PATH=./logs/audit.log
AUDIT_RETENTION_DAYS=90
AUDIT_INCLUDE_PAYLOAD=false
MESSAGE_AUDIT_ENABLED=true  # H02: auditoría completa en database

# Métricas y Observabilidad (H11 - futuro)
METRICS_ENABLED=false  # H11
PROMETHEUS_ENABLED=false  # H11
PROMETHEUS_PORT=9090
PROMETHEUS_ENDPOINT=/metrics
HEALTHCHECK_ENDPOINT=/health
HEALTH_CHECK_INTERVAL=30

SENTRY_ENABLED=false
SENTRY_DSN=your_sentry_dsn_here

GRAFANA_ENABLED=false  # H11
GRAFANA_DASHBOARD_URL=https://grafana.theaia.com
PROMETHEUS_TARGET_URL=http://prometheus.theaia.internal:9090
LOKI_LOG_SERVER=http://loki.theaia.internal:3100
ENABLE_ALERTS=false  # H11

# ---- SECURITY & CORS ----
CORS_ENABLED=true
CORS_ALLOWED_ORIGINS=https://app.theaia.com,https://admin.theaia.com
ALLOWED_HOSTS=localhost,127.0.0.1,app.theaia.com
CSRF_PROTECTION=true
CSRF_TRUSTED_ORIGINS=https://app.theaia.com

RATE_LIMIT_ENABLED=true
RATE_LIMIT_REQUESTS_PER_MINUTE=100
RATE_LIMIT_REQUESTS_PER_HOUR=1000

ENCRYPTION_ENABLED=true
ENCRYPTION_ALGORITHM=AES-256
ENCRYPTION_KEY=your_encryption_key_here_32_chars_minimum
SECRET_BACKUP_KEY=your_backup_encryption_key_here

# ---- MULTI-TENANT / RBAC (H08 - FUTURO) ----
# Base multi-tenant implementada en H02 (tenant_id obligatorio en todas las tablas)
MULTI_TENANT_ENABLED=true  # H02: arquitectura lista, RBAC completo en H08
ROLE_BASED_ACCESS_ENABLED=false  # H08
DEFAULT_ROLE=user
SUPER_ADMIN_EMAIL=admin@theaia.com

# ---- BACKUP & AUDIT ----
BACKUP_ENABLED=true
BACKUP_PATH=/var/backups/theaia/
BACKUP_CRON=0 2 * * *  # 2am daily
BACKUP_RETENTION_DAYS=30
BACKUP_COMPRESSION=true
BACKUP_ENCRYPTION_ENABLED=true

# ---- CI/CD & DEPLOY (H09 - FUTURO) ----
# Docker básico ya implementado en H01, optimización en H09
DEPLOYMENT_ENVIRONMENT=production
DOCKER_ENABLED=true  # H01: básico, H09: optimización
DOCKER_REGISTRY=registry.theaia.com
IMAGE_NAME=thea-ia
IMAGE_TAG=latest
DOCKERFILE_PATH=./Dockerfile
DOCKER_BUILD_ARGS=--build-arg BUILDKIT_INLINE_CACHE=1

K8S_ENABLED=false  # H09
K8S_NAMESPACE=theaia
K8S_CONFIG_PATH=/root/.kube/config

# ---- EMAIL & NOTIFICATIONS (H12 - FUTURO) ----
SMTP_ENABLED=false  # H12
SMTP_SERVER=smtp.theaia.com
SMTP_PORT=587
SMTP_USE_TLS=true
SMTP_USER=notifications@theaia.com
SMTP_PASSWORD=secure_password_here
SYSTEM_EMAIL=system@theaia.com
ADMIN_EMAIL=admin@theaia.com
NOTIFICATION_EMAIL_ENABLED=false  # H12

# ---- TESTING & COVERAGE ----
TESTING_MODE=false
TEST_DATABASE_URL=sqlite:///./test.db
TEST_DATABASE_ECHO=false
COVERAGE_ENABLED=false
PYTEST_CACHING=true

# H02: 12/12 tests database pasando (100%)
# Coverage actual: ~40% database layer
# Objetivo H04: ≥85% coverage

# ---- FEATURE FLAGS & EXPERIMENTAL ----
FEATURE_FLAGS=feat_database_multi_tenant,feat_telegram_adapter,feat_advanced_fsm
CUSTOM_CONFIG_PATH=./config/custom.yaml
EXPERIMENTAL_FEATURES_ENABLED=false

# Arquitectura híbrida LLM (14 nov 2025)
FEATURE_HYBRID_LLM=false  # H05-H06

# ---- INTERNAL / COMPATIBILITY ----
PYTHONUNBUFFERED=1
PYTHONDONTWRITEBYTECODE=1
ENVIRONMENT_FILE_VERSION=0.15.0
LAST_UPDATED=2025-11-14
MAINTAINER=Alvaro_Fernandez_Mota_CEO

# ---- HITOS Y ESTADO DEL PROYECTO ----
# H01: ✅ COMPLETADO (31 oct 2025) - Core, FSM, Tests, Docker básico
# H02: ✅ CORE COMPLETADO 70% (12 nov 2025) - Database + Telegram
#      - PostgreSQL multi-tenant operativo
#      - TelegramAdapter funcional con persistencia
#      - Primera conversación real (Usuario Entu, 12 nov 17:02)
#      - Web Client, OAuth2, Tests E2E → Aplazados a H05-H08
# H03: ⏳ PRÓXIMO (15-20 nov 2025) - CoreRouter + NLP básico
# H04: ⏸️ ~50% adelantado en H02 - Optimizaciones pendientes
# H05-H17: ⏳ PLANIFICADOS - Ver docs/roadmap/

# ---- IMPORTANT SECURITY & AUDIT NOTES ----
# 1. NUNCA subas .env al repositorio (protegido en .gitignore)
# 2. Cambia TODOS los valores de ejemplo antes de desplegar en producción
# 3. Usa Secrets Manager/Vault para secretos críticos en producción
# 4. PostgreSQL: usa md5/scram-sha-256 en producción, NO trust mode
# 5. Telegram: obtén token real de @BotFather antes de desplegar
# 6. Database: ejecuta 'alembic upgrade head' antes del primer uso
# 7. Multi-tenant: todas las queries filtran automáticamente por tenant_id
# 8. Actualiza esta plantilla con cada nuevo módulo/hito
# 9. Revisa logs de acceso/errores para auditoría activa
# 10. Backup automático configurado (2am daily, retención 30 días)

# ---- TROUBLESHOOTING H02 ----
# Si encuentras errores de conexión PostgreSQL:
# - Verifica que PostgreSQL está corriendo: pg_isready
# - Usa 127.0.0.1 en lugar de localhost en Windows
# - Revisa pg_hba.conf para autenticación
# - Ejecuta: alembic upgrade head para aplicar migraciones
```

---
